<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Record Selector — Live Discogs</title>
<meta name="theme-color" content="#22c55e"/>
<link rel="manifest" href="manifest.webmanifest"/>function fill(sel, values){
  sel.innerHTML = "";
  // Capitalize first letter of the select's id, use as its label
  const fieldName = sel.id.charAt(0).toUpperCase() + sel.id.slice(1);
  const opt = document.createElement('option');
  opt.value = "";
  opt.textContent = fieldName;   // simple, clean label
  sel.appendChild(opt);

  for (const v of values) {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  }
}
<style>
  :root{
    --bg:#000;          /* page background */
    --card:#0a0a0a;     /* panels/cards */
    --muted:#1a1a1a;    /* subtle surfaces */
    --text:#f5f5f5;     /* primary text */
    --border:#2a2a2a;   /* borders/dividers */
    --accent:#fff;      /* buttons/links (white) */
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:var(--text);padding:18px}
  .wrap{max-width:1200px;margin:0 auto}
  h1{font-size:24px;margin:0 0 8px;color:var(--text)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1}
  input,select,button{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b0b0b;color:var(--text)}
  input::placeholder{color:#9a9a9a}
  select{background:#0b0b0b}
  button{background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#0b0b0b;border:1px solid var(--border);color:#eaeaea}
  button:focus, input:focus, select:focus{outline:2px solid #fff;outline-offset:2px}
.table {
  overflow:auto;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
thead 
th {
  position: relative;
  user-select: none;
}
th .resizer {
  position: absolute;
  right: 0;
  top: 0;
  width: 6px;
  cursor: col-resize;
  user-select: none;
  height: 100%;
  background: transparent;
}
th .resizer:hover,
th.resizing .resizer {
  background: #555;
}
tbody tr {
  background:#0a0a0a;
  border-bottom:1px solid #333;  /* clean, light gray divider */
}
tbody tr:nth-child(even) {
  background:#0f0f0f;           /* subtle zebra striping */
}
td {
  padding:8px 10px;
  border-right:1px solid #222;  /* vertical grid line */
}
td:last-child {
  border-right:none;
}
tbody tr:hover {
  background:#1a1a1a;           /* hover contrast */
}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b0b0b;border:1px solid var(--border);margin-right:6px;font-size:11px;color:#eaeaea}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .muted{color:#9a9a9a}
  .hidden{display:none}
  a{color:#fff;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <h1>Record Selector <span class="pill">Live via Discogs API</span></h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Discogs username</label>
        <input id="username" placeholder="your Discogs username"/>
      </div>
      <div>
        <label>Discogs user token</label>
        <input id="token" placeholder="Paste token (stored locally)"/>
      </div>
      <div>
        <label>Proxy base</label>
        <input id="proxy" value="/api/discogs"/>
      </div>
      <div style="align-self:end">
        <button id="saveCfg" class="ghost">Save</button>
      </div>
      <div style="align-self:end">
        <button id="sync">Sync collection</button>
      </div>
    </div>
    <small class="muted" id="status">Idle.</small>
  </div>

  <div id="filters" class="card hidden">
    <div class="row">
      <input id="q" placeholder="Search Artist/Title…"/>
      <select id="label"></select>
      <select id="format"></select>
      <select id="decade"></select>
      <select id="genre"></select>
      <select id="style"></select>
      <select id="sort">
        <option value="artist,asc">Artist (A→Z)</option>
        <option value="artist,desc">Artist (Z→A)</option>
        <option value="title,asc">Title (A→Z)</option>
        <option value="title,desc">Title (Z→A)</option>
        <option value="year,asc">Year (old→new)</option>
        <option value="year,desc">Year (new→old)</option>
        <option value="label,asc">Label (A→Z)</option>
      </select>
      <button id="clear" class="ghost">Clear</button>
    </div>
    <div class="row">
      <span class="pill"><span id="nTotal">0</span> total</span>
      <span class="pill"><span id="nShown">0</span> shown</span>
    </div>
  </div>

  <div id="tableCard" class="card hidden table">
    <table>
      <thead>
        <tr>
          <th>Artist</th><th>Title</th><th>Label</th><th>Format</th>
          <th>Year</th><th>Decade</th><th>Genre</th><th>Style</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js'); }
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
const uniq = (arr)=> Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> a.localeCompare(b));
function decadeOf(y){ if(!y||isNaN(y))return ""; return Math.floor(y/10)*10 + "s"; }

const CFG_KEY='discogs_live_cfg_v1', COL_KEY='discogs_live_col_v1';
function loadCfg(){ try { return JSON.parse(localStorage.getItem(CFG_KEY)||'{}'); } catch(e){ return {}; } }
function saveCfg(c){ localStorage.setItem(CFG_KEY, JSON.stringify(c)); }
function saveCollection(arr){ localStorage.setItem(COL_KEY, JSON.stringify(arr||[])); }
function loadCollection(){ try { return JSON.parse(localStorage.getItem(COL_KEY)||'[]'); } catch(e){ return []; } }

function setInputs(){
  const c = loadCfg();
  if (c.username) $('username').value = c.username;
  if (c.token) $('token').value = c.token;
  $('proxy').value = c.proxy || '/api/discogs';
}
setInputs();

$('saveCfg').onclick = ()=>{
  saveCfg({ username: $('username').value.trim(), token: $('token').value.trim(), proxy: $('proxy').value.trim()||'/api/discogs' });
  $('status').textContent = 'Saved settings locally.';
};

async function proxyFetch(path){
  const c = loadCfg();
  if (!c.token) throw new Error('Missing token.');
  const url = (c.proxy||'/api/discogs') + '?path=' + encodeURIComponent(path);
  const res = await fetch(url, { headers: { 'Authorization': 'Discogs token=' + c.token } });
  if (!res.ok) throw new Error('HTTP '+res.status+' '+(await res.text()).slice(0,200));
  return res.json();
}

async function fetchCollection(username){
  $('status').textContent = 'Fetching collection (All folder)…';

  const all = [];
  const seenKeys = new Set(); // dedupe key per physical copy

  // Pull only folder 0 ("All")
  let page = 1, per = 100, pages = 1;
  while (page <= pages) {
    const j = await proxyFetch('/users/' + encodeURIComponent(username) +
                               '/collection/folders/0/releases?per_page=' + per + '&page=' + page);
    pages = j.pagination ? j.pagination.pages : 1;

    for (const it of (j.releases || [])) {
      const bi = it.basic_information || {};

      // Build a stable dedupe key:
      // Prefer unique copy id (instance_id). Fallback to release_id + date_added as a best-effort.
      const instanceId = it.instance_id;
      const releaseId  = bi.id;
      const dateAdded  = it.date_added || '';
      const key = instanceId ? `I:${instanceId}` : `R:${releaseId}|${dateAdded}`;

      if (seenKeys.has(key)) continue;
      seenKeys.add(key);

      const artist  = (bi.artists && bi.artists[0] && bi.artists[0].name) || "";
      const title   = bi.title || "";
      const labels  = (bi.labels || []).map(x => x.name).join(', ');
      const formats = (bi.formats || []).map(x => x.name).join(', ');
      const year    = bi.year || "";
      const decade  = decadeOf(parseInt(year, 10));
      const genres  = (bi.genres || []).join(', ');
      const styles  = (bi.styles || []).join(', ');

      all.push({
        instance_id: instanceId || '',
        release_id: releaseId || '',
        artist, title, labels, formats, year, decade, genres, styles,
        folder: 'All'
      });
    }

    page++;
    // polite pacing to be nice to Discogs
    await new Promise(r => setTimeout(r, 700));
  }

  return all;
}

function populateFilters(data){
  const labels = uniq(data.map(x=>x.labels));
  const fmts = uniq(data.map(x=>x.formats));
  const decs = uniq(data.map(x=>x.decade));
  const gens = uniq(data.flatMap(x=> (x.genres||'').split(',').map(s=>s.trim()).filter(Boolean)));
  const stys = uniq(data.flatMap(x=> (x.styles||'').split(',').map(s=>s.trim()).filter(Boolean)));
{
 function fill(sel, values){
  sel.innerHTML = "";
  // Capitalize first letter of the select's id, use as its label
  const fieldName = sel.id.charAt(0).toUpperCase() + sel.id.slice(1);
  const opt = document.createElement('option');
  opt.value = "";
  opt.textContent = fieldName;   // simple, clean label
  sel.appendChild(opt);

  for (const v of values) {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  }
}

let DATA=[], SHOWN=[];
function applyFilters(){
  const q = norm($('q').value);
  const lab = $('label').value, fmt=$('format').value, dec=$('decade').value, gen=$('genre').value, sty=$('style').value;
  const sort = $('sort').value.split(',');
  SHOWN = DATA.filter(x=>{
    if (q && !norm(x.artist+" "+x.title).includes(q)) return false;
    if (lab && x.labels!==lab) return false;
    if (fmt && x.formats!==fmt) return false;
    if (dec && x.decade!==dec) return false;
    if (gen && !(x.genres||'').split(',').map(s=>s.trim()).includes(gen)) return false;
    if (sty && !(x.styles||'').split(',').map(s=>s.trim()).includes(sty)) return false;
    return true;
  }).sort((a,b)=>{
    const [k,dir]=sort; const av=(a[k]||"").toString(), bv=(b[k]||"").toString();
    return dir==='asc' ? av.localeCompare(bv,undefined,{numeric:true}) : bv.localeCompare(av,undefined,{numeric:true});
  });
  $('nTotal').textContent = String(DATA.length);
  $('nShown').textContent = String(SHOWN.length);
  renderTable();
}
function renderTable(){
  const tb = $('tbody'); tb.innerHTML="";
  for (const x of SHOWN.slice(0,200)){ // show first 200 for perf
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${x.artist}</td><td>${x.title}</td><td>${x.labels}</td><td>${x.formats}</td>
                    <td>${x.year||""}</td><td>${x.decade||""}</td><td>${x.genres||""}</td><td>${x.styles||""}</td>`;
    tb.appendChild(tr);
  }
}

$('clear').onclick = ()=>{ ['q','label','format','decade','genre','style'].forEach(id=>$(id).value=""); applyFilters(); };
['q','label','format','decade','genre','style','sort'].forEach(id=>{
  $(id).addEventListener('input', applyFilters);
  $(id).addEventListener('change', applyFilters);
});

$('sync').onclick = async ()=>{
  const u = $('username').value.trim(); const t = $('token').value.trim();
  if (!u || !t){ alert('Enter username and token first.'); return; }
  saveCfg({username:u, token:t, proxy:$('proxy').value.trim()||'/api/discogs'});
  $('status').textContent = 'Syncing… this can take a minute for bigger collections';
  try{
    const col = await fetchCollection(u);
    saveCollection(col);
    DATA = col;
    $('filters').classList.remove('hidden');
    $('tableCard').classList.remove('hidden');
    populateFilters(DATA);
    applyFilters();
    $('status').textContent = 'Sync complete. Data saved locally for offline use.';
  }catch(e){
    $('status').textContent = 'Error: ' + e.message;
  }
};

// Auto-load cached collection on open
const cached = loadCollection();
if (cached && cached.length){
  DATA = cached;
  $('filters').classList.remove('hidden');
  $('tableCard').classList.remove('hidden');
  populateFilters(DATA);
  applyFilters();
  $('status').textContent = 'Loaded cached collection. Hit Sync to refresh from Discogs.';
}
</script>
<script>
// === Column Resizing ===
document.addEventListener("DOMContentLoaded", () => {
  const table = document.querySelector("table");
  if (!table) return;

  const thElems = table.querySelectorAll("thead th");
  thElems.forEach(th => {
    const resizer = document.createElement("div");
    resizer.classList.add("resizer");
    th.appendChild(resizer);

    let startX, startWidth;

    const onMouseDown = (e) => {
      startX = e.pageX;
      startWidth = th.offsetWidth;
      th.classList.add("resizing");
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    };

    const onMouseMove = (e) => {
      const dx = e.pageX - startX;
      const newWidth = Math.max(60, startWidth + dx);
      th.style.width = newWidth + "px";
    };

    const onMouseUp = () => {
      th.classList.remove("resizing");
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    };

    resizer.addEventListener("mousedown", onMouseDown);
  });
});
</script>  
</body>
</html>
